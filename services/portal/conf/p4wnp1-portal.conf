<VirtualHost *:80>
  ServerName p4wnp1.local
  ServerAlias *
  UseCanonicalName Off
  DocumentRoot /var/www/html

  # Keep the directory simple: CGI allowed, no indexes, explicit index.html
  <Directory "/var/www/html">
    Options +ExecCGI +FollowSymLinks -Indexes
    AllowOverride None
    AddHandler cgi-script .cgi .py
    Require all granted
    DirectoryIndex index.html
  </Directory>

  # Always no-cache so probes don’t get cached and CNAs re-check
  Header always set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
  Header always set Pragma "no-cache"
  Header always set Expires "0"

  RewriteEngine On

  # ------------------------------
  # 0) Mark authed (by IP-file OR cookie)
  # ------------------------------
  # IP stamp set by capture.py: /opt/p4wnp1/data/auth/<REMOTE_ADDR>
  RewriteCond "/opt/p4wnp1/data/auth/%{REMOTE_ADDR}" -f [OR]
  RewriteCond %{HTTP_COOKIE} (^|;\s*)P4WN_DONE=1(;|$)
  RewriteRule ^ - [E=AUTHED:1]

  # Small helpers
  # Don’t let /index.html/ create weird suffix loops
  RewriteRule ^index\.html/$ /index.html [R=302,L]

  # ------------------------------
  # 1) Windows (NCSI) pre-auth → 302 to portal
  #    Post-auth → 200 success bodies for probes + /redirect opens portal (200)
  # ------------------------------
  # NCSI probe files: connecttest.txt + ncsi.txt -> 302 (pre-auth)
  RewriteCond %{ENV:AUTHED} !1
  RewriteCond %{HTTP_HOST} ^(www\.)?msft(connecttest|ncsi)\.com$ [NC]
  RewriteRule ^(connecttest\.txt|ncsi\.txt)$ /index.html [R=302,L]

  # Windows captive mini-browser: /redirect -> serve portal directly (200)
  RewriteCond %{ENV:AUTHED} !1
  RewriteCond %{HTTP_HOST} ^(www\.)?msftconnecttest\.com$ [NC]
  RewriteCond %{REQUEST_URI} ^/redirect$ [NC]
  RewriteRule ^ /index.html [L]

  # Post-auth: serve local success text for the probe files
  RewriteCond %{ENV:AUTHED} =1
  RewriteCond %{HTTP_HOST} ^(www\.)?msft(connecttest|ncsi)\.com$ [NC]
  RewriteRule ^connecttest\.txt$ /probe/connecttest.txt [L]
  RewriteCond %{ENV:AUTHED} =1
  RewriteCond %{HTTP_HOST} ^(www\.)?msftncsi\.com$ [NC]
  RewriteRule ^ncsi\.txt$ /probe/ncsi.txt [L]

  # ------------------------------
  # 2) iOS/macOS CNA
  #    pre-auth: 302 to portal
  #    post-auth: 200 body "Success" (exact word) to close CNA
  # ------------------------------
  RewriteCond %{ENV:AUTHED} !1
  RewriteCond %{HTTP_HOST} ^captive\.apple\.com$ [NC]
  RewriteCond %{REQUEST_URI} ^/hotspot-detect\.html$ [NC]
  RewriteRule ^ /index.html [R=302,L]

  RewriteCond %{ENV:AUTHED} =1
  RewriteCond %{HTTP_HOST} ^captive\.apple\.com$ [NC]
  RewriteRule ^hotspot-detect\.html$ /probe/hotspot-detect.html [L]

  # ------------------------------
  # 3) Android (generate_204)
  #    pre-auth: 302 to portal; post-auth: 204
  # ------------------------------
  RewriteCond %{REQUEST_URI} ^/(generate_204|gen_204)$ [NC]
  RewriteCond %{ENV:AUTHED} !1
  RewriteRule ^ /index.html [R=302,L]

  RewriteCond %{REQUEST_URI} ^/(generate_204|gen_204)$ [NC]
  RewriteCond %{ENV:AUTHED} =1
  RewriteRule ^ - [R=204,L]

  # ------------------------------
  # 4) Firefox (detectportal)
  #    pre-auth: 302 to portal; post-auth: 200 minimal "success"
  # ------------------------------
  RewriteCond %{ENV:AUTHED} !1
  RewriteCond %{HTTP_HOST} ^detectportal\.firefox\.com$ [NC]
  RewriteRule ^canonical\.html$ /index.html [R=302,L]

  RewriteCond %{ENV:AUTHED} =1
  RewriteCond %{HTTP_HOST} ^detectportal\.firefox\.com$ [NC]
  RewriteRule ^canonical\.html$ /probe/canonical.html [L]

  # ------------------------------
  # 5) Everything else:
  #    - allow capture.py to run
  #    - non-existent paths internally serve /index.html (no external redirect)
  # ------------------------------
  RewriteCond %{REQUEST_URI} !^/capture\.py$ [NC]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule ^ /index.html [L]

  ErrorLog ${APACHE_LOG_DIR}/p4wnp1-error.log
  CustomLog ${APACHE_LOG_DIR}/p4wnp1-access.log combined
</VirtualHost>
